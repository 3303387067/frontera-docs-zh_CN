

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Cluster setup guide &mdash; Frontera 0.6.0 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="Frontera 0.6.0 documentation" href="../index.html"/>
        <link rel="next" title="Installation Guide" href="installation.html"/>
        <link rel="prev" title="Quick start distributed mode" href="quick-start-distributed.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> Frontera
          

          
          </a>

          
            
            
              <div class="version">
                0.6
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="overview.html">Frontera at a glance</a></li>
<li class="toctree-l1"><a class="reference internal" href="run-modes.html">Run modes</a></li>
<li class="toctree-l1"><a class="reference internal" href="quick-start-single.html">Quick start single process</a></li>
<li class="toctree-l1"><a class="reference internal" href="quick-start-distributed.html">Quick start distributed mode</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Cluster setup guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#things-to-decide">Things to decide</a></li>
<li class="toctree-l2"><a class="reference internal" href="#things-to-setup-before-you-start">Things to setup before you start</a></li>
<li class="toctree-l2"><a class="reference internal" href="#things-to-implement-before-you-start">Things to implement before you start</a></li>
<li class="toctree-l2"><a class="reference internal" href="#configuring-kafka">Configuring Kafka</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#create-all-topics-needed-for-kafka-message-bus">Create all topics needed for Kafka message bus</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#configuring-hbase">Configuring HBase</a></li>
<li class="toctree-l2"><a class="reference internal" href="#configuring-frontera">Configuring Frontera</a></li>
<li class="toctree-l2"><a class="reference internal" href="#starting-the-cluster">Starting the cluster</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="frontier-objects.html">Frontier objects</a></li>
<li class="toctree-l1"><a class="reference internal" href="frontier-middlewares.html">Middlewares</a></li>
<li class="toctree-l1"><a class="reference internal" href="frontier-canonicalsolvers.html">Canonical URL Solver</a></li>
<li class="toctree-l1"><a class="reference internal" href="frontier-backends.html">Backends</a></li>
<li class="toctree-l1"><a class="reference internal" href="message_bus.html">Message bus</a></li>
<li class="toctree-l1"><a class="reference internal" href="own_crawling_strategy.html">Crawling strategy</a></li>
<li class="toctree-l1"><a class="reference internal" href="scrapy-integration.html">Using the Frontier with Scrapy</a></li>
<li class="toctree-l1"><a class="reference internal" href="frontera-settings.html">Settings</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="what-is-cf.html">What is a Crawl Frontier?</a></li>
<li class="toctree-l1"><a class="reference internal" href="graph-manager.html">Graph Manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="scrapy-recorder.html">Recording a Scrapy crawl</a></li>
<li class="toctree-l1"><a class="reference internal" href="fine-tuning.html">Fine tuning of Frontera cluster</a></li>
<li class="toctree-l1"><a class="reference internal" href="dns-service.html">DNS Service</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="architecture.html">Architecture overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="frontier-api.html">Frontera API</a></li>
<li class="toctree-l1"><a class="reference internal" href="requests-integration.html">Using the Frontier with Requests</a></li>
<li class="toctree-l1"><a class="reference internal" href="examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="tests.html">Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="loggers.html">Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="frontier-tester.html">Testing a Frontier</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">F.A.Q.</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contribution guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">Glossary</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">Frontera</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
    <li>Cluster setup guide</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/topics/cluster-setup.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="cluster-setup-guide">
<h1>Cluster setup guide<a class="headerlink" href="#cluster-setup-guide" title="Permalink to this headline">¶</a></h1>
<p>This guide is targeting an initial setup of crawling cluster, probably further tuning will be needed. This guide implies
you use Kafka message bus for cluster setup (recommended), although it is also possible to use ZeroMQ, which is less
reliable option.</p>
<div class="section" id="things-to-decide">
<h2>Things to decide<a class="headerlink" href="#things-to-decide" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>The speed you want to crawl with,</li>
<li>number of spider processes (assuming that single spider process gives a maximum of 1200 pages/min),</li>
<li>number of DB and Strategy worker processes.</li>
</ul>
</div>
<div class="section" id="things-to-setup-before-you-start">
<h2>Things to setup before you start<a class="headerlink" href="#things-to-setup-before-you-start" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Kafka,</li>
<li>HBase (we recommend 1.0.x and higher),</li>
<li><a class="reference internal" href="dns-service.html"><span class="doc">DNS Service</span></a> (recommended but not required).</li>
</ul>
</div>
<div class="section" id="things-to-implement-before-you-start">
<h2>Things to implement before you start<a class="headerlink" href="#things-to-implement-before-you-start" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference internal" href="own_crawling_strategy.html"><span class="doc">Crawling strategy</span></a></li>
<li>Spider code</li>
</ul>
</div>
<div class="section" id="configuring-kafka">
<h2>Configuring Kafka<a class="headerlink" href="#configuring-kafka" title="Permalink to this headline">¶</a></h2>
<div class="section" id="create-all-topics-needed-for-kafka-message-bus">
<h3>Create all topics needed for Kafka message bus<a class="headerlink" href="#create-all-topics-needed-for-kafka-message-bus" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><a class="reference internal" href="glossary.html#term-spider-log"><span class="xref std std-term">spider log</span></a> (<cite>frontier-done</cite> (see <a class="reference internal" href="frontera-settings.html#std:setting-SPIDER_LOG_TOPIC"><code class="xref std std-setting docutils literal"><span class="pre">SPIDER_LOG_TOPIC</span></code></a>)), set the number of partitions equal to number of
strategy worker instances,</li>
<li><a class="reference internal" href="glossary.html#term-spider-feed"><span class="xref std std-term">spider feed</span></a> (<cite>frontier-todo</cite> (see <a class="reference internal" href="frontera-settings.html#std:setting-SPIDER_FEED_TOPIC"><code class="xref std std-setting docutils literal"><span class="pre">SPIDER_FEED_TOPIC</span></code></a>)), set the number of partitions equal to number of
spider instances,</li>
<li><a class="reference internal" href="glossary.html#term-scoring-log"><span class="xref std std-term">scoring log</span></a> (<cite>frontier-score</cite> (see <a class="reference internal" href="frontera-settings.html#std:setting-SCORING_LOG_TOPIC"><code class="xref std std-setting docutils literal"><span class="pre">SCORING_LOG_TOPIC</span></code></a>))</li>
</ul>
</div>
</div>
<div class="section" id="configuring-hbase">
<h2>Configuring HBase<a class="headerlink" href="#configuring-hbase" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>create a namespace <code class="docutils literal"><span class="pre">crawler</span></code> (see <a class="reference internal" href="frontera-settings.html#std:setting-HBASE_NAMESPACE"><code class="xref std std-setting docutils literal"><span class="pre">HBASE_NAMESPACE</span></code></a>),</li>
<li>make sure Snappy compression is supported natively.</li>
</ul>
</div>
<div class="section" id="configuring-frontera">
<h2>Configuring Frontera<a class="headerlink" href="#configuring-frontera" title="Permalink to this headline">¶</a></h2>
<p>Every Frontera component requires it&#8217;s own configuration module, but some options are shared, so we recommend to create
a common modules and import settings from it in component&#8217;s modules.</p>
<ol class="arabic">
<li><p class="first">Create a common module and add there:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">frontera.settings.default_settings</span> <span class="k">import</span> <span class="n">MIDDLEWARES</span>
<span class="n">MAX_NEXT_REQUESTS</span> <span class="o">=</span> <span class="mi">512</span>
<span class="n">SPIDER_FEED_PARTITIONS</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1"># number of spider processes</span>
<span class="n">SPIDER_LOG_PARTITIONS</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1"># worker instances</span>
<span class="n">MIDDLEWARES</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
    <span class="s1">&#39;frontera.contrib.middlewares.domain.DomainMiddleware&#39;</span><span class="p">,</span>
    <span class="s1">&#39;frontera.contrib.middlewares.fingerprint.DomainFingerprintMiddleware&#39;</span>
<span class="p">])</span>

<span class="n">QUEUE_HOSTNAME_PARTITIONING</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">KAFKA_LOCATION</span> <span class="o">=</span> <span class="s1">&#39;localhost:9092&#39;</span> <span class="c1"># your Kafka broker host:port</span>
<span class="n">SCORING_TOPIC</span> <span class="o">=</span> <span class="s1">&#39;frontier-scoring&#39;</span>
<span class="n">URL_FINGERPRINT_FUNCTION</span><span class="o">=</span><span class="s1">&#39;frontera.utils.fingerprint.hostname_local_fingerprint&#39;</span>
</pre></div>
</div>
</li>
<li><p class="first">Create workers shared module:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">.common</span> <span class="k">import</span> <span class="o">*</span>

<span class="n">BACKEND</span> <span class="o">=</span> <span class="s1">&#39;frontera.contrib.backends.hbase.HBaseBackend&#39;</span>

<span class="n">MAX_NEXT_REQUESTS</span> <span class="o">=</span> <span class="mi">2048</span>
<span class="n">NEW_BATCH_DELAY</span> <span class="o">=</span> <span class="mf">3.0</span>

<span class="n">HBASE_THRIFT_HOST</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span> <span class="c1"># HBase Thrift server host and port</span>
<span class="n">HBASE_THRIFT_PORT</span> <span class="o">=</span> <span class="mi">9090</span>
</pre></div>
</div>
</li>
<li><p class="first">Create DB worker module:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">.worker</span> <span class="k">import</span> <span class="o">*</span>

<span class="n">LOGGING_CONFIG</span><span class="o">=</span><span class="s1">&#39;logging-db.conf&#39;</span> <span class="c1"># if needed</span>
</pre></div>
</div>
</li>
<li><p class="first">Create Strategy worker&#8217;s module:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">.worker</span> <span class="k">import</span> <span class="o">*</span>

<span class="n">CRAWLING_STRATEGY</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="c1"># path to the crawling strategy class</span>
<span class="n">LOGGING_CONFIG</span><span class="o">=</span><span class="s1">&#39;logging-sw.conf&#39;</span> <span class="c1"># if needed</span>
</pre></div>
</div>
</li>
</ol>
<p>The logging can be configured according to <a class="reference external" href="https://docs.python.org/2/library/logging.config.html">https://docs.python.org/2/library/logging.config.html</a> see the
<a class="reference internal" href="loggers.html"><span class="doc">list of loggers</span></a>.</p>
<ol class="arabic" start="5">
<li><p class="first">Configure spiders module:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">.common</span> <span class="k">import</span> <span class="o">*</span>

<span class="n">BACKEND</span> <span class="o">=</span> <span class="s1">&#39;frontera.contrib.backends.remote.messagebus.MessageBusBackend&#39;</span>
<span class="n">KAFKA_GET_TIMEOUT</span> <span class="o">=</span> <span class="mf">0.5</span>
</pre></div>
</div>
</li>
</ol>
<p>6. Configure Scrapy settings module. It&#8217;s located in Scrapy project folder and referenced in scrapy.cfg. Let&#8217;s add
there:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">FRONTERA_SETTINGS</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>  <span class="c1"># module path to your Frontera spider config module</span>

<span class="n">SCHEDULER</span> <span class="o">=</span> <span class="s1">&#39;frontera.contrib.scrapy.schedulers.frontier.FronteraScheduler&#39;</span>

<span class="n">SPIDER_MIDDLEWARES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;frontera.contrib.scrapy.middlewares.schedulers.SchedulerSpiderMiddleware&#39;</span><span class="p">:</span> <span class="mi">999</span><span class="p">,</span>
    <span class="s1">&#39;frontera.contrib.scrapy.middlewares.seeds.file.FileSeedLoader&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">DOWNLOADER_MIDDLEWARES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;frontera.contrib.scrapy.middlewares.schedulers.SchedulerDownloaderMiddleware&#39;</span><span class="p">:</span> <span class="mi">999</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="starting-the-cluster">
<h2>Starting the cluster<a class="headerlink" href="#starting-the-cluster" title="Permalink to this headline">¶</a></h2>
<p>First, let&#8217;s start storage worker:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span># start DB worker only for batch generation
$ python -m frontera.worker.db --config [db worker config module] --no-incoming
...
# Then start next one dedicated to spider log processing
$ python -m frontera.worker.db --no-batches --config [db worker config module]
</pre></div>
</div>
<p>Next, let&#8217;s start strategy workers, one process per spider log partition:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ python -m frontera.worker.strategy --config [strategy worker config] --partition-id 0
$ python -m frontera.worker.strategy --config [strategy worker config] --partition-id 1
...
$ python -m frontera.worker.strategy --config [strategy worker config] --partition-id N
</pre></div>
</div>
<p>You should notice that all processes are writing messages to the log. It&#8217;s ok if nothing is written in streams,
because of absence of seed URLs in the system.</p>
<p>Let&#8217;s put our seeds in text file, one URL per line and start spiders. A single spider per spider feed partition:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ scrapy crawl [spider] -L INFO -s SEEDS_SOURCE = &#39;seeds.txt&#39; -s SPIDER_PARTITION_ID=0
...
$ scrapy crawl [spider] -L INFO -s SPIDER_PARTITION_ID=1
$ scrapy crawl [spider] -L INFO -s SPIDER_PARTITION_ID=2
...
$ scrapy crawl [spider] -L INFO -s SPIDER_PARTITION_ID=N
</pre></div>
</div>
<p>You should end up with N spider processes running. Usually it&#8217;s enough for a single instance to read seeds from
<code class="docutils literal"><span class="pre">SEEDS_SOURCE</span></code> variable to pass seeds to Frontera cluster. Seeds are only read if spider queue is empty.
:<a class="reference internal" href="frontera-settings.html#std:setting-SPIDER_PARTITION_ID"><code class="xref std std-setting docutils literal"><span class="pre">SPIDER_PARTITION_ID</span></code></a> can be read from config file also.</p>
<p>After some time seeds will pass the streams and will be scheduled for downloading by workers. Crawler is bootstrapped.</p>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="installation.html" class="btn btn-neutral float-right" title="Installation Guide" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="quick-start-distributed.html" class="btn btn-neutral" title="Quick start distributed mode" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014-2016, Frontera authors.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.6.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>